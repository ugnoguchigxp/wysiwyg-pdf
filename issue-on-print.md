# 印刷プレビューにおける表示見切れ問題 (Issue on Print Preview)

## 概要
WYSIWYGエディタ (Canvas/Konva) 上ではページ枠内に収まっているコンテンツが、ブラウザの印刷プレビュー機能 (HTML/CSS) を使用した際に、ページの右端で見切れてしまう（クリッピングされる）問題が発生しています。

## 現象
- **WYSIWYGエディタ**: A4サイズ (210mm x 297mm) のCanvas右端までヘッダー（青い背景のテキストボックスなど）が正常に表示されている。
- **印刷プレビュー**: 背景のボックスは表示されているが、**中のテキスト（末尾の数文字）だけが右端で見切れている**。
    - 例: "Street Address" の最後の "s"、"Postal Code" の "e" などが欠ける。
    - これは、背景ボックスの表示範囲内にテキストが収まりきらず、はみ出してクリッピングされている（または印刷不可領域にかかっている）ことを示唆する。

## 技術的要因と考察

### 1. フォントレンダリングの差異 (Font Metrics Discrepancy) - **主原因**
- **現象の分析**: 背景ボックス（Canvasと同じ幅設定）からはみ出しているということは、**HTMLでのフォント描画幅がCanvasよりも広くなっている（膨張している）** ことが確実です。
- 右寄せテキストの場合、右端を基準に左へ伸びますが、文字幅が広いと、左端がボックスを突き抜けるか、あるいは単に全体の幅が計算よりも長くなり、末尾（右端）がボックスの外にはみ出します（`text-align: right` の挙動としては右端固定で左に伸びるはずですが、ボックス内での折り返しや `white-space: pre` の扱いにより、右にはみ出すケースもあり得ます。特に単一行で強制表示している場合）。
- わずかな差（数文字分）であることから、文字間隔 (`letter-spacing`) やフォントのスケーリング調整で解決可能です。

### 2. ブラウザ・OS・プリンタドライバによる強制マージン (Hard Margins)
最も有力な原因です。
- Webブラウザの印刷機能は、OSや選択されているプリンタドライバの「印刷可能領域 (Printable Area)」設定に依存します。
- CSSで `@page { margin: 0; }` を指定しても、多くの家庭用・オフィス用プリンタドライバは、紙送り機構のために用紙の端（特に上下左右 4〜5mm）を印刷不可領域として強制的に余白化します。
- この領域にかかったHTML要素は、ブラウザによって強制的にクリッピング（切り捨て）されます。
- Canvas上では「用紙の端(0mm〜210mm)」まで自由に描画できますが、物理的な印刷では「フチなし印刷」設定を行わない限り、端まで印刷することはできません。

### 2. フォントレンダリングの差異 (Font Metrics Discrepancy)
- **Canvas (Konva)**: 独自のテキスト計測ロジックまたはブラウザのCanvas APIを使用。文字詰めが比較的タイトになる傾向があります。
- **HTML/CSS**: ブラウザのレンダリングエンジンを使用。カーニング、アンチエイリアス、フォント置換などの影響で、Canvasよりも描画幅が広くなる（膨張する）ことが一般的です。
- これにより、Canvasでは枠内に収まっていたテキストが、HTML化された際に枠（width）を超えてはみ出すことがあります。ただし、今回のケースでは「背景ボックスごと切れている」ため、これは副次的な要因と考えられます。

### 3. CSS変換・配置ロジックの限界
- 当初の実装では、HTMLのテーブルセル (`td`) 内で `text-align: right` を使用していましたが、Web標準の挙動として、セル幅を超えたテキストは右側（セルの外側＝ページの外側）へとはみ出そうとします。
- `overflow: hidden` が設定されていたため、セル幅を超えた時点で「切り捨て」が発生していました。

## 実施した対策と結果

1.  **座標単位の統一 (`pt` -> `mm`)**
    -   内容: 座標や幅の指定を `mm` に統一し、計算誤差を排除。
    -   結果: 改善なし。

2.  **テキストスタイル調整 (`letter-spacing`)**
    -   内容: フォント描画幅の膨張を抑えるため、`letter-spacing: -0.05em` を設定。
    -   結果: 多少の効果はあるが、根本的な解決には至らず。

3.  **【解決策】Flexbox配置への変更とオーバーフロー許可**
    -   内容:
        -   テーブルセル (`td`) の `overflow` を `visible` に変更し、枠外への描画を許可。
        -   セル内のテキストを `<div>` で囲み、`display: flex` を適用。
        -   右寄せコンテンツの場合、`text-align: right` ではなく **`justify-content: flex-end`** を使用。
    -   **結果**: **解決**。
        -   Flexboxの特性により、`flex-end` で配置された要素がコンテナ幅を超えた場合、**開始方向（左側）** へとはみ出す形で描画されます。
        -   これにより、右端（ページ境界）での見切れが発生せず、テキスト全体がセル領域内（または左隣のセル上）に表示されるようになりました。

4.  **【解決策】PDF出力時の白い隙間（White Gaps）対策**
    -   内容:
        -   ブラウザやPDFレンダラの仕様により、隣接する背景色付きセルの間に微細な白い隙間が発生する現象を確認。
        -   対策として、背景色を持つセルに対し、**同色のボーダー (`border: 0.5pt solid bg`)** および **ボックスシャドウ (`box-shadow: 0 0 0 1px bg`)** を適用。
    -   **結果**: **解決**。隙間が強制的に塗りつぶされ、完全なベタ塗りが再現されました。

5.  **【解決策】画像出力時のUI混入対策**
    -   内容:
        -   `toDataURL` による画像化の際、エディタ用の行・列番号ヘッダーが含まれてしまう問題を修正。
        -   ヘッダーUIに識別用クラス (`name="table-header-ui"`) を付与し、画像生成の瞬間だけ非表示にするロジックを実装。
    -   **結果**: **解決**。純粋なドキュメント内容のみが画像化されるようになりました。

---
## 結論 (Resolution)
これら一連の修正により、Canvas上のWYSIWYG表示と、HTML/PDF/画像出力の結果が視覚的に一致する状態となりました。
本件は **解決済み (RESOLVED)** とします。
