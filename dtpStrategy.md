# DTP strategy (project stance)

## 背景
- 帳票テンプレートは印刷物が最終成果物であり、版面定義の主軸は DTP 的な寸法が必須。
- 既存実装は pt を基軸に変換していたが、用紙・マージン・要素寸法を mm で把握したい。
- wysiwyg-pdf には mm を第一級単位として扱い、レンダリング時のみ px / pt に変換する仕組みを求める。

## 目標
1) テンプレート JSON の正規形を mm 基準に統一する。  
2) 画面表示では mm → px (DPI 基準) でスケールし、ズームはその上に掛ける。  
3) 印刷・PDF 生成では mm → pt (72dpi) へ変換し、用紙サイズ・余白・要素位置が一致すること。  
4) 余白キーは t/r/b/l を公式にし、top/right/bottom/left も受理して mm として解釈する。  

## wysiwyg-pdf に求める改修案
- **デフォルト単位を mm に変更**し、Doc.unit を省略時は 'mm' とみなす。
- **統一コンバータの提供**  
  - mm ↔ px: `px = mm * (dpi / 25.4)`、デフォルト dpi=96、呼び出し側で上書き可。  
  - mm ↔ pt: `pt = mm * (72 / 25.4)` をライブラリ側で一元管理。  
- **内部処理の基準**  
  - Doc/surface/node の w/h/x/y/r/fontSize/strokeW/borderW/テーブル row/col など全長さを mm で保持。  
  - Canvas/Konva 表示時のみ mm→px 変換した値を使う。  
  - PrintLayout/PDF 生成時は mm→pt 変換した値を使う。  
- **API/互換性**  
  - unit が pt/px/in で届いた場合はライブラリ内部で mm へ正規化してから扱う（警告ログ推奨）。  
  - 余白キーは t/r/b/l を正、top/right/bottom/left もフォールバックで読む。出力は t/r/b/l で揃える。  
- **設定ポイント**  
  - DPI, 最小ステップ（例: 0.1mm）, 丸め精度（表示: 2桁、保存: 3桁）をオプションで受け取れるようにする。  
  - ズームは px に変換後に掛けるため、mm 基準の寸法を汚染しない。  

## 本プロジェクトからの要望
- `ReportKonvaEditor` / `PrintLayout` 双方で mm を基準に扱う内部 API を提供してほしい。呼び出し側は Doc を mm のまま渡し、変換はライブラリ内完結としたい。
- `useReportHistory` など履歴系も mm の Doc を保持する形に統一してほしい。
- 既存データの後方互換として pt/px 受領時は自動で mm 正規化し、保存時は必ず unit:'mm' で書き出す挙動を用意してほしい。
- 変換ロジックを共有のユーティリティとして公開し、ホスト側が同一計算式を再利用できるようにしてほしい。

## 印刷精度に関する期待
- A4 縦: 210x297mm → 595.276x841.89pt（内部は 210x297mm を保持し、出力直前で pt 化）。  
- 1mm 誤差以内で余白・罫線位置が再現されること。  
- 画像リサイズ・テキストの line-height も mm 基準で制御できる API を提供。  

## 次ステップ（提案）
- ライブラリ側に「mm-first」ブランチを作成し、Doc 正規化とレンダリング変換を実装。  
- プロジェクト側では unit 変換コードを撤去し、mm Doc をそのまま渡して確認するテストを追加（A4, A5, landscape/portrait の基準スナップショット）。  
- 上記仕様が固まったらライブラリ README/API リファレンスに「単位ポリシー」を明文化。  
