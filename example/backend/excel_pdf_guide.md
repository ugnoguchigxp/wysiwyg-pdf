# Excel->PDF 出力で重要になるExcel要素（ExcelJS + react-to-print + Konva 前提）

このドキュメントは、ユーザーが自由に作るExcelを入力として、
TypeScriptベースで複数ページのPDF出力を実現する際に「重要になるExcel要素」を
実務レベルで整理したものです。Aspose.Cells相当の表現力を意識しています。

前提:
- 入力: ユーザー自由作成のExcelファイル
- 出力: PDFのみ（複数ページ対応）
- TS構成: ExcelJS + Konva canvas + react-to-print
- 目標: Canvas上の見た目をPDFへ忠実に反映

---

## 1. 印刷モデルに関わる重要情報（最優先）

Excelは「シートの描画」と「印刷のモデル」が別です。PDF出力は基本的に印刷モデルを再現します。
このため、以下が最重要です。

### 1-1. PageSetup（用紙/余白/縮尺/向き）
- 用紙サイズ（A4/Letterなど）
- 縦横（Portrait/Landscape）
- 余白（上下左右、ヘッダー/フッター）
- 縮尺（Zoom または FitToPagesWide/Tall）

TS出力側は「A4サイズ」「余白」「縮尺」を明示的に持つ必要があります。
ユーザーExcelにPageSetupがあっても、読み取れない場合は
「互換の規定値」を決める必要があります。

### 1-2. PrintArea（印刷範囲）
- どのセル範囲を印刷対象とするか
- 設定が無い場合、Excelは UsedRange を印刷対象にする

ユーザー自由作成のExcelでは、UsedRangeが意図より広いことが非常に多いです。
PDF出力時は「印刷範囲を固定する」ロジックが極めて重要になります。

### 1-3. PageBreak（改ページ）
- 手動改ページ
- 自動改ページ（縮尺や用紙サイズで決まる）

PDFで複数ページ出力する場合、どの単位でページが分かれるかが重要です。
Excelでは「表示上1枚に見えても、印刷は複数ページ」ということが普通に発生します。

---

## 2. セル描画に関わる重要情報（見た目の再現性）

### 2-1. 行高・列幅（mm変換前提）
- Excel表示の幅/高さは「ピクセル」ではなくExcel独自単位
- 出力はmmを忠実に扱う前提なので、Excel単位 -> mm の変換が最重要

行高・列幅はレイアウトの最重要情報です。
ここがズレると罫線やセル内容の位置が崩れます。

mm変換の基本方針:
- 画面上のpx/ptではなく、最終的な「物理寸法mm」に正規化する
- A4は 210mm x 297mm なので、余白を引いた「描画可能領域(mm)」から逆算する
- 行高/列幅の合計が「描画可能領域(mm)」に収まるように縮尺を決定する

実装で必要になる情報:
- 行高: Excelの行高（ポイント単位で格納されることが多い）をmmへ換算
- 列幅: Excelの列幅（文字幅ベースの独自単位）をmmへ換算

注意点:
- 列幅はフォント依存のため、同じ数値でも実mmが変動する
- フォントを固定しないとmm変換は安定しない

mm変換の基本式（実装の土台）:
- 1 inch = 25.4 mm
- 1 pt = 1/72 inch -> `mm = pt * 25.4 / 72`
- 1 CSS px = 1/96 inch -> `mm = px * 25.4 / 96`

ExcelJS前提の実務式:
- 行高: `row.height` は pt として扱う -> `rowHeightMm = row.height * 25.4 / 72`
- 列幅: `column.width` は「最大数字幅(MDW)の文字数」なので、まず px を算出してから mm 化

列幅->pxの代表式（MDWはフォントの最大数字幅(px)）:
- `px = Truncate(((256 * width + Truncate(128 / MDW)) / 256) * MDW)`
- `width` は Excel の列幅（ExcelJSの `column.width` と同義の想定）
- `MDW` はフォント依存。例: Calibri 11で約7pxが目安だが実測が望ましい

列幅->mm:
- `colWidthMm = px * 25.4 / 96`

### 2-2. 罫線（Border）
- 上下左右の線種（thin/medium/thick/dashed/dotted など）
- 線色
- セル単位の罫線は「隣接セルと重なる」ため描画順序が重要

Excelの罫線はセル境界に沿って描かれ、隣接セルで二重描画されることがあります。
Canvas描画時は「セル境界ごとの統合」処理が必要になることが多いです。

### 2-3. 塗りつぶし（Fill）
- 背景色
- パターン塗りつぶし

背景色は単純ですが、パターン塗りつぶしや透明色は実装に差が出ます。

### 2-4. 文字スタイル
- フォント名/サイズ/太字/斜体/色
- 文字揃え（水平/垂直）
- 折返し/縮小表示/インデント

Canvasで文字を描く場合、フォントの実体が環境に無いと代替フォントに置換されます。
フォント差異は最も見た目の崩れを生むポイントです。

---

## 3. 表示と印刷の差異で重要になる点

### 3-1. 表示上の拡大縮小と印刷縮尺は別
Excelの画面ズームは印刷に影響しません。
PDF出力はPageSetupの縮尺ルールを再現する必要があります。

### 3-2. 表示領域と印刷範囲は別
スクロールして見える範囲は印刷範囲とは無関係です。
ユーザーが「見えている範囲＝印刷対象」と思うケースが多いので注意。

---

## 4. ユーザー自由作成Excelで特に問題になる領域

### 4-1. UsedRangeの肥大化
- 空白セルに書式が残るとUsedRangeが広がる
- 印刷範囲が想定外に拡大し、縮尺が極端になる

対策:
- 入力時にUsedRangeを正規化する
- あるいは「実データ範囲のみを出力対象」とする

### 4-2. フォント差異
- ユーザーのExcelで使われているフォントがレンダラに無い
- 代替フォントで行幅がズレ、改行位置・セル高さが狂う

対策:
- PDF環境にフォントを埋め込む
- フォントマッピングルールを持つ

### 4-3. セル結合（Merged Cells）
- 結合セルの境界は、罫線や背景の適用ルールが特殊
- 合成領域のテキスト位置がセル単位と異なる

対策:
- 結合セルの座標系を優先して描画

### 4-4. 数式と計算結果
- ExcelJSは数式評価をしない
- ユーザーExcelの「見た目」は計算結果に依存

対策:
- 事前にExcel側で再計算されたファイルを使う
- もしくは式評価エンジンを導入する

---

## 5. 複数ページPDF出力で重要になる点

### 5-1. 自動改ページロジック
- ページサイズ + 余白 + 縮尺で「何行何列が入るか」を決める必要がある
- 行高・列幅の累積でページ境界を計算する

### 5-2. ヘッダー/フッター領域
- Excelはヘッダー/フッターを別枠として持つ
- PDF出力では「別レイヤー」として描画するのが自然

### 5-3. 罫線の途切れ問題
- ページ境界で罫線が切れる
- Excelは「ページを跨いでも連続して見える」ように見せることがある

対策:
- ページ跨ぎ境界で線を延長するルールを設ける

---

## 6. TS実装への具体的な落とし込みポイント

### 6-1. ExcelJSで取得すべきメタ情報
- 行高/列幅
- セルのフォント/文字色/揃え
- 罫線/背景
- 結合セル情報
- 印刷範囲（存在しない場合はUsedRangeから推定）

### 6-2. Konva描画での注意点（mm前提）
- セル境界ごとに罫線を統合描画する
- 文字描画はフォントが揃っていない場合の測定誤差が大きい
- 描画スケールは「A4実寸（mm）」に基づく

### 6-3. react-to-printでPDF出力する時の注意
- ブラウザの印刷エンジンに依存するため、OS差分が出る
- 印刷倍率がブラウザ側で変わるとレイアウトが崩れる

---

## 7. Aspose.Cellsでできることを踏襲する上で重要な差分

- AsposeはExcelの印刷モデルを内部で解釈してPDF化できるが、
  TSベースでは自前で印刷モデルを再現する必要がある。
- Asposeはフォント置換をある程度扱えるが、
  TS側では環境依存のフォント問題がより顕在化する。
- Asposeは計算済みのセル値を扱えるが、
  ExcelJSは数式計算ができず「値が無い」ケースが出る。

---

## 8. 最小限守るべきチェックリスト

- 印刷範囲が確定できているか
- A4サイズと余白が固定されているか
- 縮尺は固定 or ページフィットを採用しているか
- フォントの埋め込み/マッピングを行っているか
- 結合セルの描画ロジックを持っているか
- 罫線は境界線として統合描画しているか
- 行高/列幅の変換単位が正しいか
